name: Sync Wiki

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
  workflow_dispatch:

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Sync to Wiki
        run: |
          # Configurações
          WIKI_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"
          DOCS_DIR="docs"
          
          echo "Iniciando sincronização..."
          
          # Clona a wiki
          git clone $WIKI_URL tmp_wiki
          
          # Verifica explicitamente se a pasta foi criada
          if [ ! -d "tmp_wiki" ]; then
            echo "ERRO CRÍTICO: O git clone falhou ou a pasta tmp_wiki não foi criada."
            ls -la
            exit 1
          fi
          
          echo "Pasta tmp_wiki criada com sucesso. Conteúdo:"
          ls -la tmp_wiki
          
          # Limpeza segura: entra na pasta antes de apagar
          cd tmp_wiki
          echo "Limpando arquivos antigos..."
          find . -maxdepth 1 -not -name '.git' -not -name '.' -not -name '..' -exec rm -rf {} +
          cd ..
          
          # Cópia segura
          if [ -d "$DOCS_DIR" ]; then
            echo "Copiando novos arquivos..."
            cp -r $DOCS_DIR/. tmp_wiki/
          else
            echo "ERRO: Diretório de origem $DOCS_DIR não encontrado!"
            exit 1
          fi
          
          # Commit e Push
          cd tmp_wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "Nenhuma mudança detectada para commitar."
          else
            git commit -m "chore: sync wiki documentation from docs/ [skip ci]"
            git push $WIKI_URL
            echo "Wiki atualizada com sucesso!"
          fi
